<!DOCTYPE html>
<html>
	<head>
		<title>Falling</title>
		<meta charset='utf8'>
		<style>
			body {
				margin:0;
				padding:0;
				font-family:sans-serif;
			}
			.inner {
				width:984px;
				margin:0 auto;
			}
			#canvas-container {
				border:2px solid #ccccd3;
				position:relative;
				height:551px;
			}

			canvas{
				position:absolute;
				top:0;
				left:0;
				visibility:hidden;
			}
		</style>
	</head>
	<body>
		<div class="inner">
			<h1>Falling</h1>
		</div>
		<div class="inner">
			<div id="canvas-container">
				<canvas width="980" height="551">
				</canvas>
				<canvas width="980" height="551">
				</canvas>
			</div>
			<button id="stop">  â—¼ Stop</button>
		</div>
		<script src="http://documentcloud.github.com/underscore/underscore.js"> </script>
		<script>
			// Shared empty constructor function to aid in prototype-chain creation.
			var ctor = function(){};

			// Helper function to correctly set up the prototype chain, for subclasses.
			// Similar to `goog.inherits`, but uses a hash of prototype properties and
			// class properties to be extended.
			var inherits = function(parent, protoProps, staticProps) {
				var child;

				// The constructor function for the new subclass is either defined by you
				// (the "constructor" property in your `extend` definition), or defaulted
				// by us to simply call the parent's constructor.
				if (protoProps && protoProps.hasOwnProperty('constructor')) {
					child = protoProps.constructor;
				} else {
					child = function(){ parent.apply(this, arguments); };
				}

				// Inherit class (static) properties from parent.
				_.extend(child, parent);

				// Set the prototype chain to inherit from `parent`, without calling
				// `parent`'s constructor function.
				ctor.prototype = parent.prototype;
				child.prototype = new ctor();

				// Add prototype properties (instance properties) to the subclass,
				// if supplied.
				if (protoProps) _.extend(child.prototype, protoProps);

				// Add static properties to the constructor function, if supplied.
				if (staticProps) _.extend(child, staticProps);

				// Correctly set child's `prototype.constructor`.
				child.prototype.constructor = child;

				// Set a convenience property in case the parent's prototype is needed later.
				child.__super__ = parent.prototype;

				return child;
			};

			function get_digits(numbah, digitz) {
				var scalesies = Math.pow(10, digitz);
				return Math.floor(numbah * scalesies) / scalesies;
			}
		</script>
		<script>
			(function() {
				var Game =  inherits(function() { }, {
					'canvas': null,
					'width': 0,
					'height': 0,
					'context': null,
					'backbufferCanvas': null,
					'backbufferContext': null,
					'lastPaint': null,
					'objects': [],
					'gameSpeed': -.25,
					'canvIdx': 0,
					'framerate' : 0,
					'constructor': function(canvasId) {
						this.lastPaint = Date.now();

						this.canvii = document.getElementsByTagName('canvas');

						this.canvas = this.canvii[0];

						this.backbufferCanvas = this.canvii[1];

						this.context = this.canvas.getContext('2d');
						this.backbufferContext = this.backbufferCanvas.getContext('2d');

						this.width = this.canvas.width;
						this.height = this.canvas.height;

						var centerObj = new Drawable({
							x: this.width/2,
							y: this.height/2
						});
						this.objects.push(centerObj);	

						var self = this;
						this.draw = _.bind(this._draw, this);

						this.initDots();

						this.frames = 0;
						this.times = [];
						this.start = Date.now();
					},
					'initDots': function() {
						this.objects.unshift(new Background({
							vY:this.gameSpeed,
							y: this.height
						}));
					},
					'_draw': function() {
						if(!this.stop && this.objects.length > 1) {
							window.requestAnimationFrame(this.draw);
						}
						var self = this;
						var dT = Date.now() - this.lastPaint;
						var drawStart = Date.now();
						this.backbufferContext.clearRect(0, 0, this.width, this.height);
						this.objects.forEach(function(obj) {
							obj.draw(dT, self);
						});


						this.frames++;
						if(this.frames % 12 == 0) {
							this.framerate = this.frames*1000/(Date.now() - this.start);
							this.frames = 0;
							this.start = Date.now();
						}
						this.lastPaint = Date.now();
						this.backbufferContext.strokeText(get_digits(this.framerate, 2), 900, 20);
						this.swapsies();
						//this.context.clearRect(0, 0, this.width, this.height);
						//this.context.drawImage(this.backbufferCanvas, 0, 0);
					},
					'swapsies': function() {
						this.canvas = this.canvii[this.canvIdx];
						this.backbufferCanvas = this.canvii[1 - this.canvIdx];

						this.canvIdx = 1 - this.canvIdx;

						this.context = this.canvas.getContext('2d');
						this.backbufferContext = this.backbufferCanvas.getContext('2d');
						this.canvas.style.visibility = 'visible';
						this.backbufferCanvas.style.visibility = 'hidden';
					}

				});

				var Drawable = inherits(function() { }, {
					'state': { x: 0, y: 0, vX: 0, vY: 0 },
					//todo: do we need this?
					'initialState': { },
					'constructor': function(initialState) {
						this.state = _.extend({}, this.state, initialState);
						this.initialState = _.extend({}, this.initialState, this.state);
					},
					'draw': function(dT, game) {
						var centroid = {
							x: this.state.vX * dT + this.state.x,
							y: this.state.vY * dT + this.state.y,
						};

						this.doDraw(centroid, dT, game);

						this.state.x = centroid.x;
						this.state.y = centroid.y;
					},
					'doDraw': function(centroid, dT, game) {
						game.backbufferContext.beginPath(centroid.x, centroid.y);
						game.backbufferContext.arc(centroid.x - 5, centroid.y - 5, 10, 0,  2 * Math.PI);
						game.backbufferContext.stroke();
					}
				});

				var Background = inherits(Drawable, {
					'image': null,
					'ready': false,
					'constructor': function(initialState) {
						this.constructor.__super__.constructor.call(this, initialState);

						this.image = new Image();
						this.image.onload = _.bind(function() {
							this.ready = true;
						}, this);
						this.image.src = 'game-bg.jpg';
					},
					'doDraw': function(centroid, dT, game) {
						if(!this.ready) return;
						if(centroid.y <= 0) 
							centroid.y = game.height;

						var topSegment = this.image.naturalHeight - centroid.y;

						game.backbufferContext.drawImage(this.image, 0, topSegment, this.image.naturalWidth, centroid.y, 0, 0, game.width, centroid.y);
						game.backbufferContext.drawImage(this.image, 
							/* sx */0, /* sy */ 0, 
							/* sw */ this.image.naturalWidth, /* sh */ topSegment, 
							/* dx */ 0,  /* dy */ centroid.y,
							/* dw */ game.width, /* dh */ topSegment
						);
					}
				});

				window.requestAnimationFrame = window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame

				Falling = {};

				Falling.game = new Game('c');
				Falling.game.draw();

				document.getElementById('stop').addEventListener('click', function() {
					Falling.game.stop = true;
				});

			})();
		</script>
	</body>
</html>
